from sklearn import datasets
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import random
import os


def long_short_portfolio(df, percentile: float = 0.25, long_ratio = 1.5, short_ratio = -0.5):
    ls_portfolio = df.copy().fillna(0)*0
 
    for date, row in df.iterrows():
        row.dropna(inplace =True)
        row = row.sort_values(ascending=False)
        ratio_val = int(np.round(len(row)*0.25))
        long = row.sort_values(ascending=False)[0:ratio_val]
        short = row.sort_values(ascending=True)[0:ratio_val]        
        ls_portfolio.loc[date,long.index]= 1/ratio_val*long_ratio
        ls_portfolio.loc[date,short.index]= 1/ratio_val*short_ratio
        ls_portfolio.loc[date,:] = ls_portfolio.loc[date,:].div(ls_portfolio.loc[date,:].sum(), axis=0)
    return ls_portfolio

ls_portfolio = long_short_portfolio(df,0.25, 1.5, -0.5)
ls_portfolio_rtn= ls_portfolio_rtn.sum(axis=1) 
ls_portfolio_cum_rtn = (1+ls_portfolio_rtn).cumprod()

portfolio_cum_rtn.plot(label = 'Long_Short')
plt.ylabel('cumulative return (%)')
plt.legend()
